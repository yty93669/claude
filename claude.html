import React, { useState, useEffect } from 'react';
import { Card } from "@/components/ui/card";

const STORAGE_KEY = 'device-tracker-records';
const HOURS_24 = 24 * 60 * 60 * 1000; // 24小时的毫秒数

const DeviceTracker = () => {
  // 过滤并只保留24小时内的记录
  const filterRecent = (records) => {
    const now = new Date().getTime();
    return records.filter(record => {
      const recordTime = new Date(record.timestamp).getTime();
      return (now - recordTime) < HOURS_24;
    });
  };

  // 初始化时从 localStorage 读取数据，并过滤掉超过24小时的记录
  const [records, setRecords] = useState(() => {
    const savedRecords = localStorage.getItem(STORAGE_KEY);
    if (!savedRecords) return [];
    const parsedRecords = JSON.parse(savedRecords);
    return filterRecent(parsedRecords);
  });

  // 每当记录更新或每分钟自动检查一次，清理过期记录
  useEffect(() => {
    // 保存当前记录到 localStorage
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));

    // 设置定时器，每分钟检查一次过期记录
    const timer = setInterval(() => {
      setRecords(prev => filterRecent(prev));
    }, 60000); // 每分钟检查一次

    return () => clearInterval(timer); // 清理定时器
  }, [records]);

  const handleClick = () => {
    // 获取设备信息
    const userAgent = navigator.userAgent;
    const now = new Date();
    
    // 创建新记录
    const newRecord = {
      device: userAgent,
      timestamp: now.toISOString(), // 使用ISO格式存储时间以便后续处理
      displayTime: now.toLocaleString('zh-CN') // 用于显示的格式化时间
    };
    
    // 更新记录列表，同时过滤掉超过24小时的记录
    setRecords(prev => {
      const updatedRecords = [...prev, newRecord];
      return filterRecent(updatedRecords);
    });
    
    // 延迟跳转，让用户能看到记录更新
    setTimeout(() => {
      window.location.href = 'https://cc.yrai.cc';
    }, 500);
  };

  // 计算距离现在的时间
  const getTimeAgo = (timestamp) => {
    const now = new Date().getTime();
    const recordTime = new Date(timestamp).getTime();
    const diffMinutes = Math.floor((now - recordTime) / (60 * 1000));
    
    if (diffMinutes < 1) return '刚刚';
    if (diffMinutes < 60) return `${diffMinutes}分钟前`;
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}小时前`;
    return '24小时前';
  };

  return (
    <div className="flex flex-col md:flex-row gap-8 p-8 w-full max-w-6xl mx-auto">
      <div className="flex-1 flex items-center justify-center">
        <button
          onClick={handleClick}
          className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
        >
          点击跳转
        </button>
      </div>
      
      <Card className="flex-1 p-6">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold">最近24小时访问记录</h2>
          <div className="text-sm text-gray-500">
            共 {records.length} 条记录
          </div>
        </div>
        <div className="space-y-4">
          {records.map((record, index) => (
            <div key={index} className="border-b pb-2">
              <div className="font-medium">设备信息：</div>
              <div className="text-sm text-gray-600 break-all">{record.device}</div>
              <div className="font-medium mt-2">访问时间：</div>
              <div className="text-sm text-gray-600">
                {record.displayTime}
                <span className="ml-2 text-gray-400">
                  ({getTimeAgo(record.timestamp)})
                </span>
              </div>
            </div>
          ))}
          {records.length === 0 && (
            <div className="text-gray-500 text-center">暂无记录</div>
          )}
        </div>
      </Card>
    </div>
  );
};

export default DeviceTracker;
